---
nav_title: エージェント
article_title: エージェントステップ
alias: /agent_step/
page_order: 0.2
page_type: reference
description: "この参考記事では、キャンバスのエージェントステップを使用して、コンテンツを生成したり、リアルタイムでインテリジェントな意思決定を行う方法について説明する。"
tool: Canvas
---

# エージェントステップ  

> エージェント・ステップでは、AIを活用した意思決定とコンテンツ生成をキャンバスのワークフローに直接追加することができる。一般的な情報については、[Braze Agentsを]({{site.baseurl}}/user_guide/brazeai/agents/)参照のこと。 

![キャンバスユーザージャーニーのエージェントステップ。]({% image_buster /assets/img/ai_agent/agent_step.png %}){: style="float:right;max-width:30%;margin-left:15px;"}

## 仕組み

ユーザーがキャンバスのエージェントステップに到達すると、Brazeは設定した入力データ（フルコンテキストまたは選択フィールド）を選択したエージェントに送信する。そしてエージェントは、そのモデルと命令を使って入力を処理し、出力を返す。その出力は、ステップで定義した出力変数に格納される。

この変数は主に2つの方法で使うことができる：

- **決断する：**エージェントのレスポンスに基づき、ユーザーを異なるキャンバス・パスに誘導する。例えば、リードスコアリング・エージェントは1から10の間の数字を返すかもしれない。このスコアを使って、ユーザーへのメッセージングを続けるか、ジャーニーから外すかを決めることができる。
- **パーソナライゼーション:**エージェントのレスポンスをメッセージに直接挿入する。例えば、エージェントが顧客のフィードバックを分析し、顧客のコメントに言及し、解決策を提案する共感的なフォローアップメールを作成することができる。

## エージェントのステップを作成する

### ステップ 1: ステップを追加する

サイドバーから**Agent**コンポーネントをドラッグ＆ドロップするか、ステップの下部にある<i class="fas fa-plus-circle"></i> プラスボタンを選択し、**Agentを**選択する。  

### ステップ 2: エージェントを選択する  

このステップでデータを処理するエージェントを選択します。既存のエージェントを選択するか、このステップから直接新規エージェントを作成する。セットアップについては、[カスタムエージェントの作成を]({{site.baseurl}}/user_guide/brazeai/agents/creating_agents/)参照のこと。

### ステップ 3: 出力変数を定義する

エージェントの出力は「出力変数」と呼ばれ、簡単にアクセスできるように[コンテキスト変数に]({{site.baseurl}}/user_guide/engagement_tools/canvas/canvas_components/context/#context-variable-types)格納される。出力変数を定義する：

1. 変数に名前をつける。
2. データタイプを選択します。 

エージェントの出力は、文字列、数値、ブーリアン、オブジェクトとして保存できる。このため、キャンバス内のテキストパーソナライゼーションと条件ロジックの両方に柔軟に対応できる。各タイプの一般的な使い方を紹介しよう：

| データタイプ | 一般的な用途 |
| --- | --- |
| string | メッセージのパーソナライゼーション（件名、コピー、レスポンシブ） |
| 数値 | [オーディエンスパスにおける]({{site.baseurl}}/user_guide/engagement_tools/canvas/canvas_components/audience_paths)スコアリング、しきい値、ルーティング |
| ブール値 | [条件]({{site.baseurl}}/user_guide/engagement_tools/canvas/canvas_components/decision_split)分岐がある／ない |
| オブジェクト | 予測可能なデータ構造で、1つのLLMコールで1つ以上の上記のデータタイプを利用する。 |
{: .reset-td-br-1 .reset-td-br-2 role="presentation" }

定義されると、コンテキスト変数と同じテンプレート構文を使うことで、キャンバス全体で出力変数を使うことができる。**Context Variable**セグメントフィルターを使うか、Liquid:{% raw %}`{{context.${response_variable_name}}}` {% endraw %} を使ってエージェントのレスポンスを直接テンプレート化する。

オブジェクト出力変数から特定のプロパティを使うには、ドット記法を使い、Liquidを使ってそのプロパティにアクセスする： {% raw %}`{{context.${response_variable_name}.field_name}}`{% endraw %}

![Body HTML Writerのエージェント・ステップで、変数"agent_output".]({% image_buster /assets/img/ai_agent/test_agent_step.png %}にオブジェクト・データ型が出力される){: style="max-width:80%;"}

今後のキャンバスステップで、エージェント出力から特定のフィールドを参照するために、上に示したLiquid構文パターンを使用する。

### ステップ 4: エージェントに提供するコンテキストを決める  

エージェントが実行時に受け取るべきデータを決めなければならない。以下のオプションがあります。  

- すべてのキャンバスコンテキストを含める利用可能なすべてのキャンバスコンテキスト変数（[キャンバスエントリプロパティなど]({{site.baseurl}}/user_guide/engagement_tools/canvas/create_a_canvas/canvas_entry_properties_event_properties)）をエージェントステップに渡す。エージェントのステップの上流でContextのステップを使い、Contextに先行してデータを追加することができる。
- 値を提供するユーザーの名や好きな色など、選択したプロパティのみを渡す。ここで割り当てた値へのアクセス権のみをエージェントに与えるには、このオプションを選択する。それぞれの**キーについて**、特定のユーザープロファイルのフィールドやコンテキスト変数を定義する[タグを]({{site.baseurl}}/user_guide/personalization_and_dynamic_content/liquid/supported_personalization_tags)入力する。  

{% alert note %}
Brazeは、最初の10KBのコンテンツだけをエージェントに渡す。合計値が10KBを超える値を提供すると、切り捨てられる。コスト削減のため、キャンバスのBrazeエージェントは、同一の入力に対するLLMレスポンスに短命のキャッシュを使用している。すべてのキャンバス・コンテキストを含めると、キャッシュされた結果が使用できなくなる可能性が高くなり、LLMの費用が増加する可能性がある。
{% endalert %}

### ステップ 5: エージェントをテストする

エージェントステップを設定した後、このステップの出力をテストしプレビューすることができる。

## エラー処理  

- 接続モデルがレート制限エラーを返した場合、Brazeは指数関数的バックオフで最大5回再試行する。  
- その他の理由（APIキーが無効など）でエージェントが失敗した場合、出力変数は`null` に設定される。  
- 同じ入力に対するレスポンシブはキャッシュされ、繰り返し呼び出しを減らす。  

## 分析  

以下のメトリクスを参照し、Agentステップのパフォーマンスを追跡する：  

| 指標 | 説明 |
| --- | --- |
| _入力済み_ | ユーザーがエージェントステップに入った回数。 |
| _次のステップに進む_ | エージェントステップを通過した後、フローの次のステップに進んだユーザーの数。 |
| _終了済みのキャンバス_ | エージェントステップを通過してキャンバスから退出したユーザーの数。 |
{: .reset-td-br-1 .reset-td-br-2 role="presentation" }

## 関連記事  

- [Brazeエージェントの概要]({{site.baseurl}}/user_guide/brazeai/agents/)  
- [カスタムエージェントを作成する]({{site.baseurl}}/user_guide/brazeai/agents/creating_agents/)  
- [エージェントを配置する]({{site.baseurl}}/user_guide/brazeai/agents/deploying_agents/)  