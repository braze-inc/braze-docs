{コメント -%}LLMボタン用コピー - マークダウンコンテンツを処理した開発者ガイドページにのみ表示する {%- endcomment -%} {%- if page.llm_markdown_content and page.llm_markdown_content !{%- if page.llm_markdown_content and page.llm_markdown_content != "" -%} -%} -%} {%- if page.llm_markdown_content and page.llm_markdown_content !
<div id="copy-for-llm-container" class="copy-for-llm-wrapper">
  <button 
    id="copy-for-llm-btn" 
    class="btn btn-outline-secondary btn-sm copy-for-llm-button"
    data-markdown-content="{{ page.llm_markdown_content | escape }}"
    title="このページをマークダウンでコピーしてLLMの処理を簡単にする"
  > <i class="fas fa-copy" aria-hidden="true"></i> <span class="copy-for-llm-text">LLM用にコピーする</span> </button> <button 
    id="view-markdown-btn" 
    class="btn btn-outline-secondary btn-sm copy-for-llm-button"
    title="新しいタブでこのページをマークダウンで表示する"
  > <i class="fas fa-eye" aria-hidden="true"></i> <span class="copy-for-llm-text">マークダウンで表示する</span> </button> <!-- Success/Error feedback -->
  <div id="copy-for-llm-feedback" class="copy-for-llm-feedback" style="display: none;">
    <span class="copy-for-llm-message"></span>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const copyBtn = document.getElementById('copy-for-llm-btn');
  const viewMarkdownBtn = document.getElementById('view-markdown-btn');
  const feedback = document.getElementById('copy-for-llm-feedback');
  const message = feedback.querySelector('.copy-for-llm-message');
  
  if (!copyBtn) return;
  
  // Move the button to appear after the first h1 heading
  const firstH1 = document.querySelector('#article-main h1');
  if (firstH1) {
    const buttonContainer = copyBtn.closest('.copy-for-llm-page-header');
    if (buttonContainer) {
      // Insert the button container after the first h1
      firstH1.parentNode.insertBefore(buttonContainer, firstH1.nextSibling);
    }
  }
  
  copyBtn.addEventListener('click', async function() {
    const markdownContent = this.getAttribute('data-markdown-content');
    
    // Log custom event to Braze
    if (window.braze?.logCustomEvent) {
      braze.logCustomEvent("copy_for_llm_clicked", {
        page_url: window.location.pathname,
        page_title: document.title,
        content_length: markdownContent ? markdownContent.length : 0
      });
      braze.requestImmediateDataFlush();
    }
    
    if (!markdownContent) {
      showFeedback('No content available to copy', 'error');
      return;
    }
    
    try {
      // Try modern clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(markdownContent);
        showFeedback('Copied to clipboard!', 'success');
      } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyTextToClipboard(markdownContent);
      }
    } catch (err) {
      console.error('Failed to copy: ', err);
      showFeedback('Failed to copy to clipboard', 'error');
    }
  });
  
  // View as Markdown button functionality
  if (viewMarkdownBtn) {
    viewMarkdownBtn.addEventListener('click', function() {
      // Get the current page URL and convert to /index.md format
      const currentUrl = window.location.pathname;
      let markdownUrl;
      
      // Handle different URL patterns to get to /index.md
      if (currentUrl.endsWith('/')) {
        // Remove trailing slash and add /index.md
        markdownUrl = currentUrl.slice(0, -1) + '/index.md';
      } else if (currentUrl.endsWith('.html')) {
        // Replace .html with /index.md
        markdownUrl = currentUrl.replace('.html', '/index.md');
      } else {
        // Add /index.md
        markdownUrl = currentUrl + '/index.md';
      }
      
      // Log custom event to Braze
      if (window.braze?.logCustomEvent) {
        braze.logCustomEvent("view_as_markdown_clicked", {
          page_url: window.location.pathname,
          page_title: document.title,
          markdown_url: markdownUrl
        });
        braze.requestImmediateDataFlush();
      }
      
      // Open in new tab
      window.open(markdownUrl, '_blank');
    });
  }
  
  function showFeedback(text, type) {
    message.textContent = text;
    feedback.className = `copy-for-llm-feedback copy-for-llm-${type}`;
    feedback.style.display = 'block';
    
    // Hide feedback after 3 seconds
    setTimeout(() => {
      feedback.style.display = 'none';
    }, 3000);
  }
  
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Avoid scrolling to bottom
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showFeedback('Copied to clipboard!', 'success');
      } else {
        showFeedback('Failed to copy to clipboard', 'error');
      }
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
      showFeedback('Failed to copy to clipboard', 'error');
    }
    
    document.body.removeChild(textArea);
  }
});
</script>

<style>
.copy-for-llm-wrapper {
  position: relative;
  display: inline-flex;
  gap: 0.5rem;
  align-items: center;
}

.copy-for-llm-button {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  padding: 0.375rem 0.75rem;
  border: 1px solid #801ED7;
  background-color: transparent;
  color: #801ED7;
  border-radius: 0.375rem;
  transition: all 0.15s ease-in-out;
  cursor: pointer;
}

.copy-for-llm-button:hover {
  background-color: #801ED7;
  color: white;
  border-color: #801ED7;
}

.copy-for-llm-button:focus {
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(128, 30, 215, 0.25);
}

.copy-for-llm-button:active {
  background-color: #300266;
  border-color: #300266;
}

.copy-for-llm-feedback {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 0.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  z-index: 1000;
  min-width: 200px;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.copy-for-llm-success {
  background-color: #d1edff;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

.copy-for-llm-error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .copy-for-llm-button {
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
  }
  
  .copy-for-llm-wrapper {
    flex-wrap: wrap;
    gap: 0.25rem;
  }
}

/* Print styles */
@media print {
  .copy-for-llm-wrapper {
    display: none;
  }
}

/* Page header positioning */
.copy-for-llm-page-header {
  margin: 1rem 0;
  display: flex;
  justify-content: flex-start;
}

.copy-for-llm-page-header .copy-for-llm-wrapper {
  position: relative;
}

/* When positioned after h1, add some top margin for better spacing */
h1 + .copy-for-llm-page-header {
  margin-top: 0.5rem;
  margin-bottom: 1.5rem;
}
</style>
{%- endif -%} {%- endif -%} {%- endif -%} {%- endif -%}
